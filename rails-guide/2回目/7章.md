# 7章
## 確認画面を挟む
```ruby
def confirm_new
  @task = current_user.tasks.new(task_params)
  render :new unless @task.valid?
end
```
taskのパラメータを受け取り、ログインしているユーザーのtasksオブジェクトを作成する。もし@taskが検証に引っ掛からなかったら確認画面を表示する。
```ruby
resources :tasks do
  post :confirm, action: confirm_new, on: :new
end
```
/tasks/new/confirmというURLにリクエストが来たら、保存前のリソース（new）の確認をするという意味をこめて
confirm_newアクションを対応づける。

## hidden_field
画面には表示されないがリクエストを送信する時に一緒に送られる隠しフィールド

## ボタン
form要素ないのsubmitボタンが押されると、パラメータに、押されたボタンのname属性の値をキーとしてキャプションが格納される。
confirm_new.html.slimでは、戻るボタンにはbackという名前を与えているため、戻るボタンが押された時には、params[:back]で戻るという文字列を得ることができる。

## 一覧検索機能
```ruby
def index
  @q = current_user.tasks.ransack(params[:q])
  @task = @q.result(distinct: true).recent
end
```
params[:q]はビューから送られてくるパラメータ。ログインしているユーザーのtasksから検索ワードに該当するものを@qに入れている。.tasksはモデルの関連付けの際に、Userオブジェクトに関連するTaskオブジェクトを示すメソッドとして定義してある。

ransackにはマッチャーという条件とデータを照合する条件がいくつかある。
Strong Parametersの様に、検索の対象とするパラメータをモデルで指定することで、意図しない検索結果を取得されない様にする必要がある。

## ソート
```ruby
sort_link(@q, :name)
```
sort_linkの第１引数にはコントローラでransackメソッドを呼び出して得られたRansack::Searchオブジェクト（ここでは@q）、第２引数にはソートを行う対象のカラム（ここでは「名称」を表す:name）を指定する。

## メール
app/mailers/application_mailer.rb
の中でメールの送信者のアドレスをデフォルトで設定することができる。
```ruby
@task = current_user.tasks.new(task_params)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
TaskMailer.creation_email(@task).deliver_now
```
@taskで受けたパラメータをTaskMailerクラスのcreation_emailメソッドの引数に渡してメールを作成して.deliver_nowで即時送信をする。

## Active Storage
Active Storageというファイル管理gemが同梱され、クラウドストレージサービス（Amazon S3、Google Cloud Storage、 Microsoft Azure Storage）へファイルをアップロードして、データベース上でActiveRecordモデルに紐づける（添付する）ということが簡単にできる様になった。
本番環境で動かす際はRails Guideを参考にする必要がある。

## ページネーション
kaminariというgemを入れるとparams[:page]にリクエストされたpageが入る。そのため、page.(params[:page])というメソッドを使うと、表示するページを指定してくれる。

## 非同期処理
アクションの処理が重くてユーザーを待たせてしまう場合、思い処理を非同期処理として切り出し、アクションでは処理の受付だけを行うことで快適に操作できる様にしたい。  
処理の時刻を指定して処理したい。  
上記の様な場合に非同期処理を利用する。  
  
sidekiqプロセスのデータの永続化にRedesが使われる。


