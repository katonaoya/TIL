# 4章
## migration
マイグレーションファイルにバージョンを上げる様な処理を書いておくと、バージョンを下げた時にその逆の処理をしてくれる様になる。
マイグレーションファイルの名前は一意である必要があるので、ファイルの内容を具体的に記述した方が良い。

|マイグレーションのコマンド|意味|
|---|---|
|bin/rails db:migrate|最新までマイグレーションを適用する|
|bin/rails db:migrate VERSION=111111...|特定バージョンまでマイグレーションが適用された状態にする。VERSIONにはマイグレーションファイル名の先頭の数字部分（日時部分）を指定する。たとえば、ファイル名が「20180608051058_create_tasks.rb」であった場合にはVERSION=20180608051058とする。|
|bin/rails db:rollback|バージョンを１つ戻す|
|bin/rails db:rollback STEP=2|バージョンを指定したステップ数だけ戻す|
|bin/rails db:migrate:redo|バージョンを１つ戻してから１つ上げる（バージョンは最終的には変化しないが、バージョンを戻す処理が想定通り動作することを簡単に確認できる。）|

## データの内容を制限する
○カラムに保存できるデータ型には以下の様なものがある。
|:boolean|真偽値|
|:integer|符号付整数|
|:float|浮動少数点数|
|:string|文字列（短い）|
|:text|文字列（長い）|
|:date|日付|
|:datetime|日時|
○NOT NULL制約
データベースにNOT NULL制約をつけることで、かなず値を入れなければならないということを設定できる。
○文字列の長さ
limitオプションを使うことで、カラムに保存する文字列の長さを指定することができる。
○ユニークインデックス
ユニークインデックスを設定すると、同じカラムの情報の中で一意であるという設定ができる。

## saveメソッド
データベースの登録・更新を行う前に自動的に検証を行い、検証エラーがあればfalseを返す。

## 検証コードの書き方
```ruby
def 検証メソッド名
  errors.add(:カラム名, 'エラーメッセージ') if エラーが発生する条件
end
```
これで検証エラーを発見したら、errorsにエラー内容を格納することができる。

## コールバック
登録や削除などの重要なイベントの前後に任意の処理を挟むことができる。

## トランザクション
一連の複数の処理によるデータベースの生合成を保つための機能。トランザクションとしてまとめた処理の中で処理が失敗するとロールバックを起こすことができる。

## セッション
HTTPは同じユーザーから送られた一つ目のリクエストから二つ目のリクエストに情報を引き継ぐことができない。
Webアプリケーションでは、サーバー側にセッションという仕組みを養子して、一つのブラウザから連続して送られている一連のリクエストの間で状態を共有できる様にしていきます。
セッションにはハッシュの様な方体でデータを扱うことができる。

## authenticate
引数で受け取ったパスワードをハッシュ化してその結果がUserオブジェクト内部に保存されているdigestと一致するかを調べる。一致していなければfalseを返す。

## helperメソッド
helper_method指定をすることで、全てのビューから使うことができる様になる。

## ログアウト
ログアウトするにはセッションに入っているUserの情報を消すことで、ログアウトできる。

## フィルタ
ログイン機能などをつける時、各アクションの間に処理されるメソッドを作成する。
フィルタを設定すると全てのアクションの前にメソッドが発動してしまうので
```ruby
beore_action : #フィルタのメソッド名
-------
skip_before_action : #スキップするメソッド名
```
の様な形で設定をする。

## データの関連付け
データベース上ではreference
モデル上ではAssociation(has_many, belongs_to)で関連付けを行う。
モデルでの関連付けを行うことで、オブジェクトをメソッドとして呼び出すことができる様になる。

## ログインしているユーザーの情報だけ取り出す
```ruby
Task.find(params[:id])
```
というコードでは、別のアカウントでログインしているユーザーが他のユーザーのタスクidをURLに入力するとタスクを見れてしまうので、
```ruby
current_user.tasks.find(params[:id])
```
とすると自分のログインしているUserのタスクのみを見れる様にすることができる。

## データを絞り込む
データを検索などで絞り込む時には
```ruby
User.where(admin:true).first
```
起点.絞り込み条件.実行部分
という形で行う。

## scope
scopeを利用することで、繰り返し利用される絞り込み条件を読みやすくすることができる。
scopeはモデルに記載する。
```ruby
app/models/task.rb

scope :recent, -> {order(created_at: :desc) }
```
これでcreated_atが新しい順に並び替えるというrecentメソッドをscopeで定義することができた。

## controllerでフィルタを使う
privateで各アクション内で共通する箇所を定義しておいて、フィルタを使って各アクションの実行時に発動する様にすることもできる。
```ruby
before_aciton :set_task, only: [:show, :edit, :update, :destroy]

private

def set_task
  ..........
end
```
これでonlyの後に定義したメソッドの発動前にset_taskを発動させることができる。



